## 捕鱼的倍数和捕获概率分析

```C++
bool OnSubCatchFish(BYTE bDeskStation, int fish_id, BulletKind bullet_kind, int bullet_id, int bullet_mul);//鱼被抓的时候结算 (
```







```C++
bool	CServerGameDesk::ChangeCatchProperty(BYTE bDeskStation,double &fProperty,int fish_kind)
{
	if (m_pUserInfo[bDeskStation] == NULL)
	{
		return false;
	}
	DWORD dwUserID = m_pUserInfo[bDeskStation]->m_UserData.dwUserID;

	for (int i = 0;g_special_switch && i < g_vecSpecialList.size();i++)
	{
		if (dwUserID == g_vecSpecialList.at(i).user_id_)
		{
			for (int k = 0;k < SEND_FISH_NUM;k++)
			{
				if(g_vecSpecialList.at(i).special_fish_[k].fish_kind_ == fish_kind)
				{
					fProperty += g_vecSpecialList.at(i).special_fish_[k].catch_rate_ * 1.0/1000;
					return true;
				}
			}
		}
	}

	for (int i = 0; g_control_switch && i < g_vecControlList.size();i++)
	{
		if (dwUserID == g_vecControlList.at(i).user_id_)
		{
			//输 减掉
			//赢 加上
			int mul = g_vecControlList.at(i).win_or_lose_ ? 1 : -1;
			fProperty += g_vecControlList.at(i).catch_rate_* mul * 1.0/1000;
			return true;
		}
	}
	return false;
}
```









击中后功能发放

```C++
bool CServerGameDesk::OnSubCatchFish(BYTE bDeskStation, int fish_id, BulletKind bullet_kind, int bullet_id, int bullet_mul) 
{
	SCORE fish_score;
	if (NULL == m_pUserInfo[bDeskStation])
	{
		return true;
	}

	if (bullet_id == 0)
	{
		OutputDebugString("lbyfmt::::可能存在漏洞");
		return true;
	}

	if (bullet_mul < min_bullet_multiple_ || bullet_mul > max_bullet_multiple_) 
	{
		return true;
	}

	FishTraceInfo* fish_trace_info = GetFishTraceInfo(fish_id);
	if (fish_trace_info == NULL) 
	{
		return true;
	}

	if (fish_trace_info->fish_kind >= FISH_KIND_COUNT) 
	{
		return true;
	}
	
	ServerBulletInfo* bullet_info = GetBulletInfo(bDeskStation, bullet_id);
	if (bullet_info == NULL) 
	{
		return true;
	}
	
	ASSERT(bullet_info->bullet_mulriple == bullet_mul && bullet_info->bullet_kind == bullet_kind);
	if (!(bullet_info->bullet_mulriple == bullet_mul && bullet_info->bullet_kind == bullet_kind)) 
	{
		//立马释放掉这个子弹
		FreeBulletInfo(bDeskStation, bullet_info);
		fish_score = 0;
		goto TydeData;
	}
	OutputDebugString("dwjlkpy::OnSubCatchFish-4");

	//立马释放掉这个子弹
	FreeBulletInfo(bDeskStation, bullet_info);
#ifndef TEST
	if (/*!m_pUserInfo[bDeskStation]->m_UserData.isVirtual &&*/ g_stock_score_ < 0) //sdp机器人和真人一样消耗子弹2014.05.08
	{
		fish_score = 0;
		goto TydeData;
	}
#endif

	int fish_multiple = fish_multiple_[fish_trace_info->fish_kind];
	fish_score = fish_multiple_[fish_trace_info->fish_kind] * bullet_mul;
	if (fish_max_multiple_[fish_trace_info->fish_kind]>0)
	{
		int fish_mul = fish_multiple_[fish_trace_info->fish_kind] + rand() % (fish_max_multiple_[fish_trace_info->fish_kind] - fish_multiple_[fish_trace_info->fish_kind] + 1);
		fish_multiple = fish_mul;
		fish_score = fish_mul * bullet_mul;
	}
	//if (fish_trace_info->fish_kind == FISH_KIND_18) 
	//{
	//	int fish18_mul = fish_multiple_[fish_trace_info->fish_kind] + rand() % (fish18_max_multiple_ - fish_multiple_[fish_trace_info->fish_kind] + 1);
	//	fish_multiple = fish18_mul;
	//	fish_score = fish18_mul * bullet_mul;
	//} 
	//else if (fish_trace_info->fish_kind == FISH_KIND_19) 
	//{
	//	int fish19_mul = fish_multiple_[fish_trace_info->fish_kind] + rand() % (fish19_max_multiple_ - fish_multiple_[fish_trace_info->fish_kind] + 1);
	//	fish_score = fish19_mul * bullet_mul;
	//	fish_multiple = fish19_mul;
	//} 
	//else if (fish_trace_info->fish_kind == FISH_KIND_21) 
	//{
	//	fish_score = current_fish_lk_multiple_ * bullet_mul;
	//	fish_multiple = current_fish_lk_multiple_;
	//}
	if (bullet_kind >= BULLET_KIND_1_ION) 
		fish_score *= 2;

	if (fish_trace_info->fish_kind == FISH_KIND_23|| fish_trace_info->fish_kind == FISH_KIND_24 
		||(fish_trace_info->fish_kind >= FISH_KIND_31 && fish_trace_info->fish_kind <= FISH_KIND_40))
	{

	}
	else
	{
		if (fish_score <= 0)//没分就判定打不死
		{
			fish_score = 0;
			goto TydeData;
		}
	}
	
	OutputDebugString("dwjlkpy::OnSubCatchFish-5");
#ifndef TEST
	if (/*!m_pUserInfo[bDeskStation]->m_UserData.isVirtual &&*/ g_stock_score_ - fish_score < 0) //sdp机器人和真人一样消耗子弹2014.05.08
	{
		fish_score = 0;
		goto TydeData;
	}

	int change_probability = -1;
	//if (!m_pUserInfo[bDeskStation]->m_UserData.isVirtual) //sdp机器人和真人一样消耗子弹2014.05.08
	change_probability = CheckUserFilter(bDeskStation);
	//double probability = static_cast<double>((rand() % 1000 + 1)) / 1000;
	double probability = static_cast<double>((rand_Mersense(0, 1000) + 1)) / 1000;
	int stock_crucial_count = stock_crucial_count_;
	double fish_probability = fish_capture_probability_[fish_trace_info->fish_kind];
	int fish20_catch_count = 0;
	double fish20_catch_probability = 0.0;
	bool fish20_config = false;
	if (fish_trace_info->fish_kind == FISH_KIND_20 && !m_pUserInfo[bDeskStation]->m_UserData.isVirtual)
	{
		fish20_config = CheckFish20Config(bDeskStation, &fish20_catch_count, &fish20_catch_probability);
		if (fish20_config) 
		{
			fish_probability = fish20_catch_probability;
		}
	}
	OutputDebugString("dwjlkpy::OnSubCatchFish-6");
	// 机器人能打中企鹅
	if (fish_trace_info->fish_kind == FISH_KIND_20 && m_pUserInfo[bDeskStation]->m_UserData.isVirtual) 
		fish_probability = 0.02;

	if (change_probability == 0) 
	{
		fish_probability *= 0.2;
	} 
	else if (change_probability == 1) 
	{
		fish_probability *= 1.3;
	}
	if (special_scene_ && (fish_trace_info->fish_kind == FISH_KIND_1 || fish_trace_info->fish_kind == FISH_KIND_2)) 
		fish_probability *= 0.7;

	// 炸弹库根据库存调整概率
	if (/*!m_pUserInfo[bDeskStation]->m_UserData.isVirtual && */fish_trace_info->fish_kind == FISH_KIND_23 && g_stock_score_ < bomb_stock_)
		fish_probability = 0;
	if (/*!m_pUserInfo[bDeskStation]->m_UserData.isVirtual && */fish_trace_info->fish_kind == FISH_KIND_24 && g_stock_score_ < super_bomb_stock_)
		fish_probability = 0;
	OutputDebugString("dwjlkpy::OnSubCatchFish-7");
	//////////////////////////////////////////////////////新加对3-9号鱼的难度处理
	if (!m_pUserInfo[bDeskStation]->m_UserData.isVirtual)
	{
		static int nFish=0;	//捕中过,10次经过逻辑一次
		static bool bRunFish=true;	//控制周期内是否捕中
		static double m_dRand[7]={0.2,0.3,0.5,0.6,0.8,0.4,1.0};//几率随机

		if (bRunFish==false)
		{
			if(fish_trace_info->fish_kind == FISH_KIND_3 || fish_trace_info->fish_kind == FISH_KIND_4 || fish_trace_info->fish_kind == FISH_KIND_5 || fish_trace_info->fish_kind == FISH_KIND_6 || fish_trace_info->fish_kind == FISH_KIND_7 || fish_trace_info->fish_kind == FISH_KIND_8 || fish_trace_info->fish_kind == FISH_KIND_9)
			{
				nFish++;

				if(nFish>=10)
				{
					nFish=0;
					bRunFish = true;//10次后走正常逻辑，不在走概率随机
				}
				else
				{  
					fish_probability *= m_dRand[rand()%7];
				}
			}
		}

		if(bRunFish)
		{
			if(fish_trace_info->fish_kind == FISH_KIND_3 || fish_trace_info->fish_kind == FISH_KIND_4 || fish_trace_info->fish_kind == FISH_KIND_5 || fish_trace_info->fish_kind == FISH_KIND_6 || fish_trace_info->fish_kind == FISH_KIND_7 || fish_trace_info->fish_kind == FISH_KIND_8 || fish_trace_info->fish_kind == FISH_KIND_9)
			{
				bRunFish = false;
			}
		}
	}
	//////////////////////////////////////////////////////
	OutputDebugString("dwjlkpy::OnSubCatchFish-8");
	// 机器人打中几率增加
	if (m_pUserInfo[bDeskStation]->m_UserData.isVirtual) 
		fish_probability *= 1.3;


	ChangeCatchProperty(bDeskStation,fish_probability,fish_trace_info->fish_kind);
	while ((--stock_crucial_count) >= 0) 
	{
		if (!m_pUserInfo[bDeskStation]->m_UserData.isVirtual) //真人才如此判断
		{
			if (g_stock_score_ >= stock_crucial_score_[stock_crucial_count]) 
			{
				if (probability > (fish_probability * (stock_increase_probability_[stock_crucial_count]))) 
				{
					OutputDebugString("sdp_ 超端 抓鱼 失败！-----------");

					fish_score = 0;
					goto TydeData;
				} 
				else 
				{
					break;
				}
			}
		}
		else//机器人放宽，不要受 g_stock_score_ 干扰sdp2014-05-09
		{
			if (probability > (fish_probability * (stock_increase_probability_[stock_crucial_count]) +1)) 
			{
				OutputDebugString("sdp_ 超端 抓鱼 失败！-----------");

				fish_score = 0;
				goto TydeData;
			} 
			else 
			{
				break;
			}
		}
	}

	OutputDebugString("dwjlkpy::OnSubCatchFish-9");
	if (fish20_config) 
		AddFish20Config(bDeskStation, fish20_catch_count - 1, fish20_catch_probability);
#endif

	WORD chair_id = bDeskStation;
	if (fish_trace_info->fish_kind == FISH_KIND_23|| fish_trace_info->fish_kind == FISH_KIND_24 
		||(fish_trace_info->fish_kind >= FISH_KIND_31 && fish_trace_info->fish_kind <= FISH_KIND_40)) 
	{
		SaveSweepFish(fish_trace_info->fish_kind, fish_id, bullet_kind, bullet_mul);
		CMD_S_CatchSweepFish catch_sweep_fish;
		catch_sweep_fish.chair_id = chair_id;
		catch_sweep_fish.fish_id = fish_id;
		catch_sweep_fish.fish_score = fish_score;
		//sdp机器人和真人一样消耗子弹2014.05.08
		SendDataToPlayer(/*m_pUserInfo[bDeskStation]->m_UserData.isVirtual ? android_chairid_ : */chair_id, &catch_sweep_fish, sizeof(CMD_S_CatchSweepFish), SUB_S_CATCH_SWEEP_FISH);
		SendWatchData(m_bMaxPeople,&catch_sweep_fish, sizeof(CMD_S_CatchSweepFish),MDM_GM_GAME_NOTIFY,SUB_S_CATCH_SWEEP_FISH,0);
	} 
	else 
	{
		fish_score_[chair_id] += fish_score;

		if (!m_pUserInfo[bDeskStation]->m_UserData.isVirtual)
			g_stock_score_ -= fish_score;

		CMD_S_CatchFish catch_fish;
		catch_fish.bullet_ion = fish_multiple >= 15 && (rand() % 100 < 10);
		catch_fish.chair_id = bDeskStation;
		catch_fish.fish_id = fish_id;
		catch_fish.fish_kind = fish_trace_info->fish_kind;
		catch_fish.fish_score = fish_score;
		if (fish_trace_info->fish_kind == FISH_KIND_22) 
		{
			KillAllTimer();
			SetTimer(kLockTimer, kLockTime * 1000);
		}

		if (catch_fish.bullet_ion) 
		{
			SetTimer(kBulletIonTimer + chair_id, kBulletIonTime * 1000);
		}

		SendDataToAllPlayers(&catch_fish, sizeof(catch_fish), SUB_S_CATCH_FISH);
		SendWatchData(m_bMaxPeople,&catch_fish, sizeof(catch_fish),MDM_GM_GAME_NOTIFY,SUB_S_CATCH_FISH,0);

		if (fish_trace_info->fish_kind == FISH_KIND_21 || fish_trace_info->fish_kind == FISH_KIND_20 || fish_trace_info->fish_kind == FISH_KIND_19 || fish_trace_info->fish_kind == FISH_KIND_18) 
		{
			current_fish_lk_multiple_ = fish_multiple_[fish_trace_info->fish_kind];

			//发送打到李逵的系统消息
			CMD_S_CatchSweepFishResultEx cmd;
			memset(&cmd, 0, sizeof(cmd));
			if (m_pUserInfo[chair_id] != NULL)
			{
				CopyMemory(cmd.szNickName, m_pUserInfo[chair_id]->m_UserData.nickName, sizeof(cmd.szNickName));//昵称
				CopyMemory(cmd.cRoomName, m_pDataManage->m_InitData.szGameRoomName, sizeof(cmd.szNickName));//房间名字
				CopyMemory(cmd.cFishName, m_cFishName[fish_trace_info->fish_kind], sizeof(cmd.cFishName));//鱼名字
				cmd.exchange_ratio_userscore_ = exchange_ratio_userscore_;	//换算比例中用户金币
				cmd.exchange_ratio_fishscore_ = exchange_ratio_fishscore_;	//换算比例中鱼币
				cmd.iDeskID = m_pUserInfo[chair_id]->m_UserData.bDeskNO;			//桌子ID
				cmd.fish_kind = fish_trace_info->fish_kind;				//鱼类型ID
				cmd.fish_score = fish_score;		//打中鱼赚多少钱

				OutputDebugString("dwjlkpy::OnSubCatchFish-10");
				//发送广播消息，通知所有桌子，某某玩家打中Boss鱼
				m_pDataManage->m_TCPSocket.SendDataBatch(&cmd,sizeof(cmd),MDM_GM_GAME_NOTIFY,SUB_S_CATCH_SWEEP_FISH_RESULT_EX,0);
			}

		} else if (fish_trace_info->fish_kind == FISH_KIND_20) 
		{
			TCHAR tips_msg[1024] = { 0 };
		}
	}

	FreeFishTrace(fish_trace_info);
	FreeBulletInfo(chair_id, bullet_info);
TydeData:

	if (g_special_switch && fish_score > 0)
	{
		if(UpdateSpecialData(bDeskStation,fish_trace_info->fish_kind))
		{
			TidySpecialData();
			FreeFishTrace(fish_trace_info);
			return true;
		}
	}
	if (g_control_switch)
	{
		UpdateControllerMoney(bDeskStation,-fish_score);
		TidyControlData();
	}
	UpDateRealMoney(m_pUserInfo[bDeskStation]->m_UserData.dwUserID,fish_score_[bDeskStation]);

	//FreeFishTrace(fish_trace_info);
	return true;
}

```





##### 能量炮的获得代码

```C++
catch_fish.bullet_ion = fish_multiple >= 15 && (rand() % 100 < 10);// 鱼的倍数是15,且10%几率
```



```

```