### 斗地主发牌函数分析



1.两张为函数来发

```C++
//发送扑克给用户//发牌
BOOL CServerGameDesk::SendCard()
{
	if (m_iSendCardPos == m_iSendCount)
	{
		KillTimer(TIME_SEND_CARD);
		SendCardFinish();
		return TRUE;
	}
	//todo 配牌的信息因该写在这里
	//继续发送扑克(1次发两张)
	for(int i = 0; i < 2; i ++)
	{
		BYTE bDeskStation = (m_iDealPeople + m_iSendCardPos) % PLAY_COUNT;
		SendCardStruct SendCard;
		SendCard.bDeskStation = bDeskStation;
		SendCard.bCard = m_iUserCard[bDeskStation][m_iSendCardPos/PLAY_COUNT];

		for(int i = 0; i < PLAY_COUNT; i ++)
			SendGameDataEx(i,&SendCard,sizeof(SendCard),MDM_GM_GAME_NOTIFY,ASS_SEND_CARD,0);
		SendWatchData(m_bMaxPeople,&SendCard,sizeof(SendCard),MDM_GM_GAME_NOTIFY,ASS_SEND_CARD,0);

		SendCardMsg(bDeskStation,SendCard.bCard);

		m_iUserCardCount[bDeskStation] ++;
		m_iSendCardPos ++;
		if(m_iSendCardPos == m_iSendCount)
			break;
	}
	return TRUE;
}
```



2.一次完成发送到客户端

```C++
///一次發所有牌
/// 为防止外挂看牌器存在，只发自己的手牌，他人的手牌清空。
/// 旁观玩家不发任何牌，以免作弊现象
/// 由ZXD修改于20100314
BOOL	CServerGameDesk::SendAllCard()//mark
{
	SendAllStruct TSendAll;

	for(int i = 0; i < PLAY_COUNT; i ++)
	{
		m_iUserCardCount[i] = m_iUserCount;		
		TSendAll.iUserCardCount[i] = m_iUserCardCount[i];
	}
	//fixme 配牌需要查重
	LoadPeiPai();
	for(int i = 0; i < PLAY_COUNT; i ++)
	{
		TSendAll.iUserCardCount[i] = m_iUserCardCount[i];
	}

	//发送数据
	int iPos = 0;
	int iTempPos = 0 ;
	for(int i = 0;i < PLAY_COUNT; i ++)
	{
		int iTempPos = 0 ;
		for(int  j  = 0  ; j < PLAY_COUNT  ;j++)
		{
			if(i == j ||m_GameMutiple.sMingPaiMutiple[j] > 0)
			{
				::CopyMemory(&TSendAll.iUserCardList[iTempPos],m_iUserCard[j],sizeof(BYTE)*m_iUserCardCount[j]);
			}

			iTempPos += m_iUserCardCount[j] ; 
		}
	
		iPos += m_iUserCardCount[i];
		SendGameDataEx(i,&TSendAll,sizeof(TSendAll),MDM_GM_GAME_NOTIFY,ASS_SEND_ALL_CARD,0);
		SendWatchData(i,&TSendAll,sizeof(TSendAll),MDM_GM_GAME_NOTIFY,ASS_SEND_ALL_CARD,0);
		::ZeroMemory(&TSendAll.iUserCardList, sizeof(TSendAll.iUserCardList));
	}


	m_iSendCardPos ++;
	if(m_iSendCardPos == 1)
	{
		KillTimer(TIME_SEND_ALL_CARD);
		SetTimer(TIME_SEND_CARD_ANI , m_iSendCardTime *1000) ; ///给玩家发牌定时器
		return TRUE;
	}

	return FALSE;
}
```



